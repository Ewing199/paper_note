# 1.网络层:IP（网际协议）
## 1.1 ARP
*请求得知目标ip的物理地址*
在ARP高速缓存里放入一个IP地址到硬件地址的映射表，并为每个项目都设置生存时间：找到物理地址则写入ARP缓存以便快速通讯，找不到则将路由器IP地址解析为硬件地址，由路由器继续转发

## 1.2 IP报文的格式
1. 协议版本：4位，**IPV4:4，IPV6:6**
2. 首部长度：4位 **最大为60字节，为4字节的证书倍，固定长度20字节，最大60字节等**
3. 区分服务：8位 ，**一般未使用**
4. 总长度：16位，**首部长度+数据长度(不超过数据链路层规定的最大传送单元--MTU)**
5. 标识：16，**产生一个数据报，计数+1，数据报超度超过MTU的长度需要分片时，该字段被复制到所有分片中，即同一数据包的标识相同**
6. 标志：3，**最低位MF：0(没有分片)，1(还有分片)；中间位DF：0(允许分片)，1(不允许分片)**
7. 片偏移：13，**片在分组中的相对位置，便宜为8的整数倍，```offset = lenth(前片的数据长度)/8```**
8. 生存时间：8,**数据报在网络中的寿命，由原来的秒数已改为路由跳数限制**
9. 协议：8，**报文的协议，如ICMP，IGMP，TCP等等**
10. 首部检验和：16，**校验首部部分，每经过一次路由器，某些字段都会发生变化，计算方法```16位字为一段，检验和先置零，进行反码求和(按位相加，最高位进位结果+1），再取反码```**
11. 源地址：32
12. 目的地址：32

## 1.3 路由转发（不划分子网）
**（目的IP地址，下一跳地址）**
发送数据报时会不断的重复，查找路由表，通过目的IP计算硬件地址，写入MAC桢首部等过程，会造成一定的开销
>路由表的建立与更新


> 分组转发算法：
1.提取目的Ip 地址D，计算网络地址N
2.N直接与当前路由器相连，**直接交付**；否则，执行下一步
3.路由表中有到达网络D的路由，数据报传到路由表指向的路由器；否则，执行下一步
4.路由表中有到达网络N的路由，数据报传到路由表指向的路由器；否则，执行下一步
5.路由表中有默认路由，数据报传向默认路由器；否则，执行下一步
6.上报报文转发分组出错
*注意：若划分子网，每次找寻目的网络N时需要与子网掩码相&Ω*

## 1.4 划分子网
在IP地址中增加一个“子网号字段”，使两级IP变为三级IP

>划分子网的意义：
即在大型网络中可以划分出小块网络的方法，增加类灵活性，减少类主机数量
1.IP地址的空间利用率低
2.一个物理网络对应一个网络IP消耗太大
3.两级IP地址不灵活：两级即为**{网络号，主机号}**

>划分子网的解决办法：
1.从网络的**主机号**借用若干位作文子网号subnet-id，变为三级ip：**{网络号，子网号，主机号}**
2.对外该网络仍然为一个网络，该单位拥有许多物理网络
3.接收数据报，仍然是按照数据报的目的网络号找到本单位网的路由器。但是路由器会按照目的网络号和子网号找到目的子网，再转发给目的主机

> 子网掩码：使路由器能正确的提取目的Ip地址中要找的子网的网络地址，得出方法“网络号+借用的主机号全为1”
A类：默认0xFF000000，即255.0.0
B类：默认0xFFFF0000，即255.255.0.0
C类：默认0xFFFFFF00，即255.255.255.0

## 1.5 无分类编址CIDR
“sider”
两种写法，如```192.168.121.98/27或00010001*```
> 网络前缀：
**提出意义**
1.B类地址被分配殆尽
2.因特网主干上的路由表项目数急剧增长
3.IPV4地址空间即将耗尽
**解决办法**
1.无分类两级编址：**{网络前缀，主机号}/前缀位数**
2.网络前缀相同的的连续IP地址组成“CIDR地址块”，其中主机地址全0，全1一般不使用
3.地址掩码：网络前缀长度为全1的个数,*也可以扩充网络前缀划分子网*
*路由表可以利用CIDR地址块来查找目的网络，称为路由聚合，也称构成超网（如可以包含多个C类网络）*
4.最长前缀匹配：查找路由表时得到不止一个结果，其中一般取最长的结果
5.二查线索：把无分类编址的路由表存放在一种层次的数据结构中

## 1.6 网际报文控制协议ICMP
在IP数据报的数据部分写入，应用如windows的ping，unix的traceroute
**分为ICMP差错报告报文和ICMP询问报文**
> ICMP差错报文：
1. 终点不可达：路由器和主机不能交付数据报
2. 源点抑制：因为拥塞丢弃数据报时发送，，告知源点降低发送速率
3. 时间超过：当终点在预先规定时间不能收到一个数据报的全部数据时，把已有数据报丢失，并发送时间超过报文
4. 参数问题：收到数据报的首部中有字段的值不正确时，丢弃数据报，发送参数问题数据报
5. 改变路由（重定向）：路由器发送该报文，告知主机应将数据报发送给另外的路由器

> ICMP询问报文
1. 回送请求和回答：主机向一个特定的主机发出询问，，**如Ping**
2. 时间戳请求和回答：请求某个主机回复当前的日期和时间

## 1.7多播
服务器发送数据时只发送一次，路由器收到分组时会复制分组使用IGMP协议
分为**局域网上的硬件多播和因特网上的多播**
### 1.7.1硬件多播
### 1.7.2多播协议
分为IGMP和路由选择协议
> IGMP网际组管理协议
1.新的主机加入多播组时，该主机向多播组的多播地址发送一个IGMP报文，多播路由器收到把新的成员关系转发给其他多播路由器
2.组成全关系动态：多播路由器周期性询问局域网主机，只要又一个主机相应，多播路由器认为该组活跃；否则，认为组已离开，不在转发组成员关系
实现方案：
采用IP多播
询问ip组成员关系时只用发送一个请求信息的询问报文
同一个网络有多个多播路由器时，能够迅速的选择其中一个，不会增加网络负担
IGMP存在一个数值N，指明最长的相应时间
同一个组内每个主机都要监听响应

> 多播路由选择协议
实际上时寻找以源主机为为根结点的多播转发树
1.洪泛与减除：一开始广播多播数据报，发现某个路由器没有多播组的成员，就将路由器与下游树枝一起剪除
2.隧道技术：物理地址很分散的情况，在多播数据报上再次封装，达到单播数据报，通过**隧道**发送
3.基于核心的发现技术：为每个多播组指定一个核心路由器

## 1.8虚拟专用网VPN
指定一些**专用地址**，只用于机构内部通许，不能用与因特网的主机通信，路由器不会转发目的地址是专用地址的数据报，
虚拟专用给地址，利用因特网作为本机构各专用网之间的通信载体
> 实现原理（IP 隧道技术）：
主机X在网络A有专用地址10.1.0.0,连接因特网路由器R1的接口125.1.2.3,主机Y在网络B有专用地址10.2.0.0,连接因特网R2的接口194.4.5.6
X先封装源地址10.1.0.x,目的地址10.2.0.y的IP数据报，数据报先发送到路由器R1加密重新封装源地址125.1.2.3，目的地址194.4.5.6，在因特网上传输，最终传送到路由器R2上，由路由器R2解密回复原来数据报，最终发送到主机Y的Ip10.2.0.y上

## 1.9网络地址转化NAT
专用网内部已经有了IP地址，但想与外网通信。
实现方法：路由器至少有一个有效但外部全球地址，在路由器上安装NAT软件，将本地地址转换成全球IP地址进行通信，

# 2.传输层
IP层找到主机，传输层用于将报文传送到应用程序
**复用和分用**
有两个重要到功能，复用和分用：
复用：在**发送方**不同到应用进程使用同一个运输层协议
分用：在**接收方**剥去报文首部能正确到交付到目的应用进程中
**TCP和UDP** 
用户数据报协议UDP
传输控制协议TCP
确认应用程序到方式是封装端口号

## 2.1 UDP
UDP只在IP报文上增加了一点功能，主要是特点：**无连接**、**尽最大努力交付**、**面向报文**、**无拥塞控制**、**支持一对一，一对多，多对一，多对多**、**首部开销小（源端口，目的端口，长度，检验和）**

## 2.2 TCP
> 特点：
- 面向连接:连接的端点叫套接字或插口{socket=（IP地址：端口号）}
- 点对点传输
- 可靠交付
- 全双工通信
- 面向字节流

### 2.2.3可靠传输
停止等待协议：每发送完一个分组，等待确认，再发送第二个分组：连续ARQ协议：每次发送收到一个确认，移动一格窗口，接收方在收到几个分组之后对按序到达对最后一个分组发送确认
滑动窗口协议：

## 2.3TCP报文首部
1. 源端口和目的端口：各占两个字节
2. 序号：占4字节
3. 区分服务：8位 ，**一般未使用**
4. 总长度：16位，**首部长度+数据长度(不超过数据链路层规定的最大传送单元--MTU)**
5. 标识：16，**产生一个数据报，计数+1，数据报超度超过MTU的长度需要分片时，该字段被复制到所有分片中，即同一数据包的标识相同**


































